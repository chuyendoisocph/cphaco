<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Debugger - CPHACO</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #2d2d2d;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.1);
        }

        h1 {
            color: #00ff00;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .section {
            background: #1e1e1e;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            color: #ffff00;
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 10px;
        }

        .token-info {
            margin: 10px 0;
            padding: 10px;
            background: #2d2d2d;
            border-radius: 5px;
        }

        .label {
            color: #00aaff;
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }

        .value {
            color: #00ff00;
            word-break: break-all;
        }

        .value.error {
            color: #ff0000;
        }

        .value.warning {
            color: #ffaa00;
        }

        .value.success {
            color: #00ff00;
        }

        .button {
            background: #00ff00;
            color: #1e1e1e;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s;
        }

        .button:hover {
            background: #00cc00;
            transform: scale(1.05);
        }

        .button.danger {
            background: #ff0000;
            color: white;
        }

        .button.danger:hover {
            background: #cc0000;
        }

        .log {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 15px;
        }

        .log-entry {
            margin: 3px 0;
            padding: 3px 0;
        }

        .log-entry.error {
            color: #ff0000;
        }

        .log-entry.warning {
            color: #ffaa00;
        }

        .log-entry.success {
            color: #00ff00;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-badge.ok {
            background: #00ff00;
            color: #1e1e1e;
        }

        .status-badge.error {
            background: #ff0000;
            color: white;
        }

        .status-badge.warning {
            background: #ffaa00;
            color: #1e1e1e;
        }

        pre {
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 11px;
        }

        .token-preview {
            max-height: 150px;
            overflow-y: auto;
            background: #000;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç TOKEN DEBUGGER</h1>

        <div class="section">
            <div class="section-title">üìä LOCALSTORAGE SCAN</div>
            <div id="localStorageInfo"></div>
            <button class="button" onclick="scanLocalStorage()">üîÑ Qu√©t l·∫°i</button>
            <button class="button danger" onclick="clearAllTokens()">üóëÔ∏è X√≥a t·∫•t c·∫£ tokens</button>
        </div>

        <div class="section">
            <div class="section-title">üîê TOKEN ANALYSIS (CP_AUTH_TOKEN)</div>
            <div id="tokenAnalysis"></div>
        </div>

        <div class="section">
            <div class="section-title">‚è∞ TOKEN EXPIRY CHECK</div>
            <div id="expiryCheck"></div>
        </div>

        <div class="section">
            <div class="section-title">üß™ PROFILE.JS SIMULATION</div>
            <button class="button" onclick="simulateProfileCheck()">‚ñ∂Ô∏è Ch·∫°y test checkAuth()</button>
            <div class="log" id="simulationLog"></div>
        </div>

        <div class="section">
            <div class="section-title">üìù ACTIVITY LOG</div>
            <div class="log" id="activityLog"></div>
        </div>
    </div>

    <script>
        const TOKEN_KEY = 'CP_AUTH_TOKEN';
        const OLD_KEYS = ['authToken', 'token', 'jwt', 'access_token'];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('activityLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString('vi-VN');
            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : type === 'warning' ? '‚ö†' : '‚Ñπ';
            
            entry.textContent = `[${timestamp}] ${icon} ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function scanLocalStorage() {
            log('B·∫Øt ƒë·∫ßu qu√©t localStorage...', 'info');
            
            const infoDiv = document.getElementById('localStorageInfo');
            let html = '<div class="token-info">';
            
            // Check all possible token keys
            const allKeys = [TOKEN_KEY, ...OLD_KEYS];
            let foundTokens = [];
            
            allKeys.forEach(key => {
                const token = localStorage.getItem(key);
                if (token) {
                    foundTokens.push({key, token, length: token.length});
                    const isCorrect = key === TOKEN_KEY;
                    html += `
                        <div style="margin: 10px 0; padding: 10px; background: ${isCorrect ? '#004400' : '#440000'}; border-radius: 5px;">
                            <span class="label">${key}:</span>
                            <span class="value ${isCorrect ? 'success' : 'error'}">${isCorrect ? '‚úì OK' : '‚úó OLD'}</span>
                            <span class="status-badge ${isCorrect ? 'ok' : 'error'}">${token.length} chars</span>
                            <div class="token-preview">${token.substring(0, 100)}...</div>
                        </div>
                    `;
                    log(`T√¨m th·∫•y: ${key} (${token.length} chars)`, isCorrect ? 'success' : 'warning');
                }
            });

            if (foundTokens.length === 0) {
                html += '<div class="value error">‚ùå Kh√¥ng t√¨m th·∫•y token n√†o!</div>';
                log('Kh√¥ng t√¨m th·∫•y token n√†o trong localStorage', 'error');
            }

            // Show all other localStorage items
            html += '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #00ff00;">';
            html += '<div class="label">T·∫•t c·∫£ localStorage items:</div>';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                const display = value.length > 50 ? value.substring(0, 50) + '...' : value;
                html += `<div style="margin: 5px 0;"><span class="label">${key}:</span> <span class="value">${display}</span></div>`;
            }
            html += '</div>';

            html += '</div>';
            infoDiv.innerHTML = html;
            
            analyzeToken();
            checkExpiry();
            
            log('Qu√©t xong!', 'success');
        }

        function analyzeToken() {
            const analysisDiv = document.getElementById('tokenAnalysis');
            const token = localStorage.getItem(TOKEN_KEY);
            
            if (!token) {
                analysisDiv.innerHTML = '<div class="value error">‚ùå Kh√¥ng c√≥ token CP_AUTH_TOKEN</div>';
                log('Token CP_AUTH_TOKEN kh√¥ng t·ªìn t·∫°i', 'error');
                return;
            }

            let html = '<div class="token-info">';
            
            try {
                // Check JWT format
                const parts = token.split('.');
                html += `<div><span class="label">JWT Parts:</span> <span class="value ${parts.length === 3 ? 'success' : 'error'}">${parts.length} ${parts.length === 3 ? '‚úì' : '‚úó (ph·∫£i l√† 3)'}</span></div>`;
                
                if (parts.length !== 3) {
                    html += '<div class="value error">‚ùå Token kh√¥ng ƒë√∫ng format JWT!</div>';
                    log('Token kh√¥ng ƒë√∫ng format JWT (c·∫ßn 3 parts)', 'error');
                    analysisDiv.innerHTML = html + '</div>';
                    return;
                }

                // Decode header
                try {
                    const header = JSON.parse(atob(parts[0]));
                    html += `<div><span class="label">Header:</span></div><pre>${JSON.stringify(header, null, 2)}</pre>`;
                    log('Decode header th√†nh c√¥ng', 'success');
                } catch (e) {
                    html += `<div class="value error">‚ùå L·ªói decode header: ${e.message}</div>`;
                    log(`L·ªói decode header: ${e.message}`, 'error');
                }

                // Decode payload
                try {
                    const base64Url = parts[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => 
                        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                    ).join(''));
                    const payload = JSON.parse(jsonPayload);
                    
                    html += `<div><span class="label">Payload:</span> <span class="status-badge ok">OK</span></div><pre>${JSON.stringify(payload, null, 2)}</pre>`;
                    log('Decode payload th√†nh c√¥ng', 'success');
                    
                    // Check required fields
                    const requiredFields = ['email', 'exp'];
                    requiredFields.forEach(field => {
                        const hasField = payload.hasOwnProperty(field);
                        html += `<div><span class="label">${field}:</span> <span class="value ${hasField ? 'success' : 'error'}">${hasField ? '‚úì C√≥' : '‚úó Thi·∫øu'}</span></div>`;
                        if (!hasField) {
                            log(`Payload thi·∫øu field: ${field}`, 'error');
                        }
                    });

                } catch (e) {
                    html += `<div class="value error">‚ùå L·ªói decode payload: ${e.message}</div>`;
                    log(`L·ªói decode payload: ${e.message}`, 'error');
                }

                html += `<div><span class="label">Signature:</span> <span class="value">${parts[2].substring(0, 20)}...</span></div>`;

            } catch (error) {
                html += `<div class="value error">‚ùå L·ªói ph√¢n t√≠ch: ${error.message}</div>`;
                log(`L·ªói ph√¢n t√≠ch token: ${error.message}`, 'error');
            }

            html += '</div>';
            analysisDiv.innerHTML = html;
        }

        function checkExpiry() {
            const expiryDiv = document.getElementById('expiryCheck');
            const token = localStorage.getItem(TOKEN_KEY);
            
            if (!token) {
                expiryDiv.innerHTML = '<div class="value error">‚ùå Kh√¥ng c√≥ token ƒë·ªÉ ki·ªÉm tra</div>';
                return;
            }

            let html = '<div class="token-info">';

            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT format');
                }

                const base64Url = parts[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => 
                    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                ).join(''));
                const payload = JSON.parse(jsonPayload);

                if (!payload.exp) {
                    html += '<div class="value warning">‚ö†Ô∏è Token kh√¥ng c√≥ th·ªùi gian h·∫øt h·∫°n (exp)</div>';
                    log('Token kh√¥ng c√≥ exp field', 'warning');
                } else {
                    const expDate = new Date(payload.exp * 1000);
                    const now = new Date();
                    const isExpired = now >= expDate;
                    const timeLeft = expDate - now;
                    const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));

                    html += `<div><span class="label">Th·ªùi gian h·∫øt h·∫°n:</span> <span class="value">${expDate.toLocaleString('vi-VN')}</span></div>`;
                    html += `<div><span class="label">Th·ªùi gian hi·ªán t·∫°i:</span> <span class="value">${now.toLocaleString('vi-VN')}</span></div>`;
                    html += `<div><span class="label">Tr·∫°ng th√°i:</span> <span class="value ${isExpired ? 'error' : 'success'}">${isExpired ? '‚ùå ƒê√É H·∫æT H·∫†N' : '‚úì C√≤n hi·ªáu l·ª±c'}</span></div>`;
                    
                    if (!isExpired) {
                        html += `<div><span class="label">Th·ªùi gian c√≤n l·∫°i:</span> <span class="value success">${hoursLeft} gi·ªù ${minutesLeft} ph√∫t</span></div>`;
                        log(`Token c√≤n hi·ªáu l·ª±c: ${hoursLeft}h ${minutesLeft}m`, 'success');
                    } else {
                        html += `<div class="value error">‚ö†Ô∏è Token ƒë√£ h·∫øt h·∫°n! ƒê√¢y l√† l√Ω do b·ªã y√™u c·∫ßu ƒëƒÉng nh·∫≠p l·∫°i.</div>`;
                        log('Token ƒë√£ h·∫øt h·∫°n!', 'error');
                    }
                }

            } catch (error) {
                html += `<div class="value error">‚ùå L·ªói ki·ªÉm tra: ${error.message}</div>`;
                log(`L·ªói ki·ªÉm tra expiry: ${error.message}`, 'error');
            }

            html += '</div>';
            expiryDiv.innerHTML = html;
        }

        function simulateProfileCheck() {
            const logDiv = document.getElementById('simulationLog');
            logDiv.innerHTML = '';

            function simLog(message, type = 'info') {
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = message;
                logDiv.appendChild(entry);
                logDiv.scrollTop = logDiv.scrollHeight;
            }

            simLog('=== B·∫ÆT ƒê·∫¶U SIMULATION ===', 'info');
            simLog('ƒêang m√¥ ph·ªèng logic checkAuth() c·ªßa profile.js...', 'info');
            simLog('', 'info');

            const token = localStorage.getItem(TOKEN_KEY);
            
            if (!token) {
                simLog('‚ùå FAIL: Kh√¥ng t√¨m th·∫•y token CP_AUTH_TOKEN', 'error');
                simLog('‚Üí profile.js s·∫Ω redirect v·ªÅ signin.html', 'warning');
                log('Simulation: Token kh√¥ng t·ªìn t·∫°i', 'error');
                return;
            }

            simLog(`‚úì Token t·ªìn t·∫°i (${token.length} chars)`, 'success');

            try {
                const parts = token.split('.');
                simLog(`‚úì Token c√≥ ${parts.length} parts`, parts.length === 3 ? 'success' : 'error');
                
                if (parts.length !== 3) {
                    simLog('‚ùå FAIL: Token kh√¥ng ƒë√∫ng format JWT (c·∫ßn 3 parts)', 'error');
                    simLog('‚Üí L·ªói: Invalid JWT format', 'error');
                    simLog('‚Üí profile.js s·∫Ω X√ìA token v√† redirect v·ªÅ signin.html', 'warning');
                    log('Simulation: Token format kh√¥ng h·ª£p l·ªá', 'error');
                    return;
                }

                simLog('‚úì B·∫Øt ƒë·∫ßu decode payload...', 'info');
                const payload = JSON.parse(atob(parts[1]));
                simLog('‚úì Decode payload th√†nh c√¥ng', 'success');
                
                const exp = payload.exp * 1000;
                const now = Date.now();
                
                simLog(`Token exp: ${new Date(exp).toLocaleString('vi-VN')}`, 'info');
                simLog(`Current time: ${new Date(now).toLocaleString('vi-VN')}`, 'info');
                
                if (now >= exp) {
                    simLog('‚ùå FAIL: Token ƒë√£ h·∫øt h·∫°n!', 'error');
                    simLog('‚Üí profile.js s·∫Ω X√ìA token v√† redirect v·ªÅ signin.html', 'warning');
                    log('Simulation: Token h·∫øt h·∫°n', 'error');
                    return;
                }

                const timeLeft = exp - now;
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                
                simLog(`‚úì Token c√≤n hi·ªáu l·ª±c (${hours}h ${minutes}m)`, 'success');
                simLog(`‚úì User email: ${payload.email}`, 'success');
                simLog('', 'info');
                simLog('=== K·∫æT QU·∫¢: PASS ‚úì ===', 'success');
                simLog('Token h·ª£p l·ªá, profile.js s·∫Ω KH√îNG x√≥a token', 'success');
                log('Simulation: Token h·ª£p l·ªá, PASS', 'success');

            } catch (error) {
                simLog(`‚ùå FAIL: L·ªói khi parse token`, 'error');
                simLog(`‚Üí Error: ${error.message}`, 'error');
                simLog('‚Üí profile.js s·∫Ω X√ìA token v√† redirect v·ªÅ signin.html', 'warning');
                log(`Simulation: L·ªói parse - ${error.message}`, 'error');
            }
        }

        function clearAllTokens() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ tokens?')) return;

            log('ƒêang x√≥a t·∫•t c·∫£ tokens...', 'warning');
            
            const allKeys = [TOKEN_KEY, ...OLD_KEYS];
            let deletedCount = 0;
            
            allKeys.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    deletedCount++;
                    log(`ƒê√£ x√≥a: ${key}`, 'warning');
                }
            });

            log(`ƒê√£ x√≥a ${deletedCount} tokens`, 'success');
            
            setTimeout(() => {
                scanLocalStorage();
            }, 500);
        }

        // Auto scan on load
        window.addEventListener('load', () => {
            log('Token Debugger kh·ªüi ƒë·ªông', 'success');
            setTimeout(() => {
                scanLocalStorage();
            }, 500);
        });

        // Auto refresh every 30 seconds
        setInterval(() => {
            log('Auto refresh...', 'info');
            scanLocalStorage();
        }, 30000);
    </script>
</body>
</html>
