<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleanup Old Tokens - CPHACO</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .status-box h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .token-list {
            list-style: none;
            margin: 10px 0;
        }

        .token-list li {
            padding: 8px;
            background: white;
            margin: 5px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #333;
        }

        .token-list li.old {
            background: #ffe5e5;
            color: #d63031;
        }

        .token-list li.current {
            background: #e5ffe5;
            color: #00b894;
        }

        .button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .button:active {
            transform: translateY(0);
        }

        .button.success {
            background: linear-gradient(135deg, #00b894, #00cec9);
        }

        .button.danger {
            background: linear-gradient(135deg, #d63031, #e17055);
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert.info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #1565c0;
        }

        .alert.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }

        .alert.warning {
            background: #fff3e0;
            color: #e65100;
            border-left: 4px solid #e65100;
        }

        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
            display: none;
        }

        .log.show {
            display: block;
        }

        .log-entry {
            margin: 3px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Token Cleanup Tool</h1>
        <p class="subtitle">C√¥ng c·ª• d·ªçn d·∫πp token c≈© trong localStorage</p>

        <div id="alerts"></div>

        <div class="status-box">
            <h3>üìä Tr·∫°ng th√°i hi·ªán t·∫°i:</h3>
            <p id="status">ƒêang qu√©t localStorage...</p>
            <ul class="token-list" id="tokenList"></ul>
        </div>

        <button class="button" id="scanBtn" onclick="scanTokens()">üîç Qu√©t Token</button>
        <button class="button danger" id="cleanBtn" onclick="cleanupTokens()" style="display: none;">üóëÔ∏è X√≥a Token C≈©</button>
        <button class="button success" id="doneBtn" onclick="goToDashboard()" style="display: none;">‚úì Ho√†n t·∫•t - V·ªÅ Dashboard</button>

        <div class="log" id="log"></div>
    </div>

    <script>
        const CORRECT_TOKEN_KEY = 'CP_AUTH_TOKEN';
        const OLD_TOKEN_KEYS = ['authToken', 'token', 'jwt', 'access_token'];
        
        let foundTokens = {
            correct: null,
            old: []
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const timestamp = new Date().toLocaleTimeString('vi-VN');
            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ';
            
            entry.textContent = `[${timestamp}] ${icon} ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            logDiv.classList.add('show');
        }

        function showAlert(message, type = 'info') {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alertsDiv.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function scanTokens() {
            log('B·∫Øt ƒë·∫ßu qu√©t localStorage...', 'info');
            
            foundTokens = {
                correct: null,
                old: []
            };

            const tokenList = document.getElementById('tokenList');
            tokenList.innerHTML = '';

            // Check correct token
            const correctToken = localStorage.getItem(CORRECT_TOKEN_KEY);
            if (correctToken) {
                foundTokens.correct = {
                    key: CORRECT_TOKEN_KEY,
                    value: correctToken
                };
                
                const li = document.createElement('li');
                li.className = 'current';
                li.textContent = `‚úì ${CORRECT_TOKEN_KEY} (Token hi·ªán t·∫°i - OK)`;
                tokenList.appendChild(li);
                
                log(`T√¨m th·∫•y token ƒë√∫ng: ${CORRECT_TOKEN_KEY}`, 'success');
            } else {
                const li = document.createElement('li');
                li.textContent = `‚úó ${CORRECT_TOKEN_KEY} (Kh√¥ng t√¨m th·∫•y)`;
                tokenList.appendChild(li);
                
                log(`Kh√¥ng t√¨m th·∫•y token: ${CORRECT_TOKEN_KEY}`, 'error');
            }

            // Check old tokens
            OLD_TOKEN_KEYS.forEach(key => {
                const token = localStorage.getItem(key);
                if (token) {
                    foundTokens.old.push({ key, value: token });
                    
                    const li = document.createElement('li');
                    li.className = 'old';
                    li.textContent = `‚ö† ${key} (Token c≈© - n√™n x√≥a)`;
                    tokenList.appendChild(li);
                    
                    log(`T√¨m th·∫•y token c≈©: ${key}`, 'info');
                }
            });

            // Update status
            const statusDiv = document.getElementById('status');
            if (foundTokens.old.length > 0) {
                statusDiv.textContent = `T√¨m th·∫•y ${foundTokens.old.length} token c≈© c·∫ßn x√≥a`;
                document.getElementById('cleanBtn').style.display = 'block';
                showAlert(`‚ö†Ô∏è T√¨m th·∫•y ${foundTokens.old.length} token c≈©. N√™n x√≥a ƒë·ªÉ tr√°nh xung ƒë·ªôt!`, 'warning');
            } else if (foundTokens.correct) {
                statusDiv.textContent = '‚úÖ Ch·ªâ c√≥ token ƒë√∫ng, kh√¥ng c√≥ token c≈©';
                document.getElementById('doneBtn').style.display = 'block';
                showAlert('‚úì H·ªá th·ªëng ƒë√£ s·∫°ch s·∫Ω! Kh√¥ng c√≥ token c≈©.', 'success');
            } else {
                statusDiv.textContent = '‚ùå Kh√¥ng t√¨m th·∫•y token n√†o. C·∫ßn ƒëƒÉng nh·∫≠p l·∫°i.';
                showAlert('‚ùå Kh√¥ng c√≥ token. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'warning');
                
                setTimeout(() => {
                    window.location.href = 'signin.html';
                }, 3000);
            }

            log('Ho√†n t·∫•t qu√©t localStorage', 'success');
        }

        function cleanupTokens() {
            if (foundTokens.old.length === 0) {
                showAlert('‚úì Kh√¥ng c√≥ token c≈© ƒë·ªÉ x√≥a', 'info');
                return;
            }

            log('B·∫Øt ƒë·∫ßu x√≥a token c≈©...', 'info');

            let deletedCount = 0;
            foundTokens.old.forEach(({ key }) => {
                try {
                    localStorage.removeItem(key);
                    deletedCount++;
                    log(`ƒê√£ x√≥a: ${key}`, 'success');
                } catch (error) {
                    log(`L·ªói khi x√≥a ${key}: ${error.message}`, 'error');
                }
            });

            // Clear old tokens array
            foundTokens.old = [];

            // Update UI
            document.getElementById('cleanBtn').style.display = 'none';
            document.getElementById('doneBtn').style.display = 'block';
            
            showAlert(`‚úì ƒê√£ x√≥a ${deletedCount} token c≈© th√†nh c√¥ng!`, 'success');
            log(`Ho√†n t·∫•t! ƒê√£ x√≥a ${deletedCount} token`, 'success');

            // Rescan to verify
            setTimeout(() => {
                scanTokens();
            }, 1000);
        }

        function goToDashboard() {
            log('Chuy·ªÉn h∆∞·ªõng v·ªÅ Dashboard...', 'info');
            showAlert('ƒêang chuy·ªÉn h∆∞·ªõng...', 'info');
            
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1000);
        }

        // Auto scan on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                scanTokens();
            }, 500);
        });
    </script>
</body>
</html>
